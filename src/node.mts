import { deepEqual } from 'node:assert';
import { createHmac, webcrypto } from 'node:crypto';
import { readFile } from 'node:fs/promises';
import path from 'node:path';
import { fileURLToPath } from 'node:url';
import { getBip39 } from './modules.mjs';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);
const IS_BUNDLED = __dirname.endsWith('dist') === false;

Reflect.set(globalThis, 'crypto', webcrypto);
// if (IS_BUNDLED) {
//   Reflect.set(globalThis, 'Buffer', undefined);
// }

/// 初始化安装
await (async () => {
  const { setup } = await import('./index.mjs');

  const ASSETS_PATH = path.resolve(
    __dirname,
    IS_BUNDLED ? './assets' : '../assets',
  );
  await setup({
    wasmBaseUrl: ASSETS_PATH,
    async wasmLoader(wasmUri) {
      console.log('loading', wasmUri);
      return new Uint8Array(await readFile(wasmUri)).buffer;
    },
  });
  console.log('🎉 setup done!');
})();

/// hash-wasm
await (async () => {
  const { bip39 } = await getBip39();
})();

/// 助记词
await (async () => {
  const { walletUtil } = await import('./index.mjs');
  const { mnemonic, seedBuff } = await walletUtil.generateRandomMnemonic(12);
  console.log('mnemonic:', mnemonic);
  console.log('seedBuff:', seedBuff.toString('hex'));
  deepEqual(await walletUtil.findPhraseErrors(mnemonic), undefined);
  console.log(
    'calcForDerivationPath:',
    await walletUtil.calcForDerivationPath(
      'TRX - Tron',
      seedBuff.toString('hex'),
      0,
    ),
  );
})();

/// 测试算法库
await (async () => {
  const { prepareBip32 } = await import('./lib/bip32/_setup.mjs');
  await prepareBip32();

  const { hmacSHA512 } = await import('./lib/bip32/crypto.mjs');

  const key = Buffer.from('key');
  const data = Buffer.from('data');
  deepEqual(
    hmacSHA512(key, data).toString('hex'),
    createHmac('sha512', key).update(data).digest('hex'),
    'hmac 算法异常',
  );
})();

/// RUN DEMO
await (async () => {
  const { walletUtil } = await import('./index.mjs');

  const testRes = await walletUtil.calcForDerivationPath(
    'ETH - Ethereum',
    '208ea2315c340b913f36f8cca16ed04396b3ec2ce0a20bb4eec7f473824af7a32217161f65f93901dd9ebaf2d3b090cee46355b853f513dff8e75f3a4f5245f6',
    0,
  );
  deepEqual(
    {
      privkey:
        '0x7467bdc870acb3615e84fe24a2417884128af83bbe0b7e77f043c9c6c79b624f',
      pubkey:
        '0x03dbb4930b2d9527c572b4287a0e90323179aeb0028140c4da0786a95ce906c273',
      address: '0x98f8a8D289D6e32976ECDaa6C31B2dBb47B2263B',
    },
    testRes,
    '派生路径生成ETH地址异常',
  );
  console.log(testRes);
})();

await (async () => {
  const { walletUtil } = await import('./index.mjs');

  const testRes = await walletUtil.calcForDerivationPath(
    'TRX - Tron',
    '208ea2315c340b913f36f8cca16ed04396b3ec2ce0a20bb4eec7f473824af7a32217161f65f93901dd9ebaf2d3b090cee46355b853f513dff8e75f3a4f5245f6',
    0,
  );
  deepEqual(
    {
      privkey:
        '695073298f70902d9e6eee3e30779e92fefc52999f034f27bcddb8c73d44a740',
      pubkey:
        '038204f94ad43fb86d9b1ab511c8887d8991d1ca7fa6a759be75772bdfb691e18c',
      address: 'TVuDMsMbG9K3sJsGX3vvS7t7dynaN3hVwH',
    },
    testRes,
    '派生路径生成TRX地址异常',
  );
  console.log(testRes);
})();
await (async () => {
  const { walletUtil } = await import('./index.mjs');
  console.log('BTC - Bitcoin Testnet: from seed');
  const purpose = 44;
  const coinName = 'BTC - Bitcoin Testnet';
  const testRes = await walletUtil.calcForDerivationPath(
    coinName,
    '46021cfdf9d8049289bf9f655c587382d5b80f4ee9e8d20753c770c5a7cf539d7a17cc0b7ce49595fddb8b5d097e124e23943d77461baf1d00942e358c52f18d',
    0,
    purpose,
  );
  console.log(testRes);
})();

console.log('✅ all test passed.');

await (async () => {
  const { walletUtil } = await import('./index.mjs');
  /// image reflect innocent unable bonus quality donor basic method notable bulk wisdom
  const res = await walletUtil.createBitcoinPsbt({
    coinName: 'BTC - Bitcoin Testnet',
    privateKey: 'cV1Gkke4E3SnAaLXs221YDiXSTMyPzecmYLRasVofWN8meazDxdN',
    utxos: [
      {
        txid: '569c46b38d7920842544185bf96cc9a210ff892a0119bf83efb9170533227602',
        value: '2000',
        txHex:
          '02000000000101f83f7fd5d4664d41b318ff668e6d3e822c84d168df3a1d76b206f675249ed1460000000000fdffffff4cb80b000000000000160014e2d8267ed7248787c96caf24f704a6ea7519ed92e8030000000000001600147dc563dc2b425223ae514312d5ce4b871f9196467017000000000000160014a9dc2f098380b3530d15d07b8c1218eccb6f66fde8030000000000001600143a5e86276c81ed6a2afdb79b8e69e40eb822543ae803000000000000225120171394a0a4653f49eccf857c784e0ce5e3c4518c3d6179153659c4ddf805cf3bb80b000000000000160014d8c22c59d6f3539a635c0135eb1af15f77507c72e8030000000000002251203e5f519589502022e747d3c41c7f34e942e72d5ab7453995cfcf4a92066abf0ee803000000000000160014348755d10105dad2ee719d0eb4681d8e28ee2585e80300000000000016001403d1c8643394f5dd8f6f41c2051ab12d8b6b9132e80300000000000016001422172173d545a1fb43ef0fe65f69f87271fb33afd007000000000000160014f5737c153d7f2535f4596a341081606544d0dc5be80300000000000022512043225d4d3cbc8caa8f3d253150bce14eb5c15cea28a94ee5e61d67c3c0f66d2cd0070000000000002251208e5deb0265b8452675e4f5367ab377c845ca2798490fa749baeab7b6f2f96b16b80b0000000000001600141428845e90530ae925f9f202c84768fa70279263e8030000000000001600142f859159e0c5ff07b4b400330ef1c0d05a053e7ce8030000000000001600144b2924d8168e30eb0daf71656ee291e43632d315e80300000000000022512075ff45ac71eb85110cdb69c969abc5ceabe8bced5eccb015ed6ef33579763be0b80b000000000000160014c23c8548979066e01c2d59da0b974021918706c8e803000000000000160014c76f50d4f8d0fa7445f951539ed7f102f8f0c6ece803000000000000225120871c0725144d3f6383635ac152b08c2aa23321314e43c00256c472631a7a354cb80b00000000000016001441281ef171d08eda91c8b44fb82021dc8f463e7ee803000000000000160014f984adde3c4493c643d21df54dbab97a0810e33de8030000000000002251200857a0299f01d7ad34f350ff049bc01412f3b3330c6ba6d3dc3b97a5b86ed963e803000000000000160014b99d2607a0c96be396325add3d0677ac8088a7c4e8030000000000001600147df7fde874b01da598910208ff1b79e1533c6dcce803000000000000225120435bbfa6a0c3fcdb8998e7b924ddc71e2440a6d8407a4e651ec7324a1e3605dee8030000000000002251201d018a8f89a55faa04697e6e9e8c5c9deb294a301870dcea04cdd81509dcca66b80b000000000000225120cb3bf63c0234fc0daed5129689c664d76f2873cf6bae37ae17fbfb8a5e613f02e803000000000000225120f6af294b4603b2562e97dca956467aec58818afcc3c36deee4c5b77c2c4f3cffd0070000000000002251202b6477646c679356c0fda8c8c424d923a1bb72b52e55c29767a5b47493cd661fb80b00000000000016001400cfbeeb1a34190cf7e9b293f16502e5b3774845e803000000000000160014e50c0185600e95cbc67c48d90de5604a4681e18ee803000000000000160014c9cb82f4da8f9e399dfbc5fcd33e1e94f387102fe803000000000000160014b8ed3cf96678ab403011462176717b20815d4b51e803000000000000160014b2a3f4fe81a5f8429ddf38432d5b1684dba37af7e8030000000000001600141e6fb728907bedc0b0fd01d8441fea6dc3475962e803000000000000160014d0701b87b405c61670e6ac4e5ef7a5cb8920284ce80300000000000022512076ead45f91269814d76af28d2f47052752a6870311342f8ac795406c845444a3e803000000000000160014ad938b7fd890196a5bbad96686b12aa00830a177e803000000000000225120525902bd85d49c5e09ed4e50ccea607932bdcb98eeb97249c85e8037e3241963e8030000000000002251205f572a077306621cff9fbdb8419dadbefc56c10172c24c98a4479a8178728a45e803000000000000160014d1f96b3714b5ff119306f1ba875d938d6536f116e803000000000000225120e091133dafe8c74155584111dda6ccf59bc6d9f4607377e947d4103540c510dbb80b000000000000160014e01dcfad98b9ce5991daa05a143a2ae767fafd9de803000000000000160014a195d67601f9da1c56ba125d5570a959206acad5e8030000000000001600147f05f36a12c1f4ec21ed3f1970f13c9c66e362c9e80300000000000016001480a965d7136188f0bf44c5a27eb4344531684d91e8030000000000001600147b677e316f92360f16e0894e9999394048ca1047e80300000000000022512057c1aec5a5d24bcd3c8453c9fedd89af88e9454147221a19f4599978f4a75e23d0070000000000001600149845641b558915e5fd9b3fccad2d24cabd701260e8030000000000002251200172d53d9c965b7b460ff96e2995ef98e599a10e4ee5f971466ffa6e58919b44b80b000000000000160014af4e6109763bd60ee0c71e3379e0d453f4203ef87017000000000000160014b4187faf0579e5ad33c42d741f44239753a85e6be80300000000000016001409387d06fb76fe8aea85737151f47dccf9c12e92a00f00000000000016001456a77c74d363ac7b324ce64e10ece5a7a89fdadbb80b000000000000160014a867df7f78c556ca3d9f38937b92867807e8f9e1a00f0000000000001600149a6b22c1214c182e0fa9376e812731a50e573d86e803000000000000160014107a19344e4d9e0450d43160e27df54fec8db6a9b80b00000000000022512062ae31c875bc9af159b9c73328bd2b0cd8294e0076e5ba212453feac9ac00957960f00000000000016001473e3e3b6848dffb9f7e4205c10dd2e4e3b951079e803000000000000160014a19e74d1427efeaad597161123651690dbaaf6fae80300000000000016001456217664b6c2d80b5f3a80cedfdb1510d2dff390b80b00000000000016001479aa02d41c071357e7faa1be2e427f9befb79ef2e8030000000000002251205e4f31fbe906e29d006dd106250e236a76fa323d1683b72a46e1ea5ab58ea5147017000000000000225120c5fa7f036be571bc4bd437be9e130e020e85859d3e360aa83db5eb261cf84b75e803000000000000160014a6a1da1d227ba3c16f7738290d4157f3092e2b6fd0070000000000002251208e1280b368b041226aa558115ed4bc1fe1daeab5ff2b6e43529b4da7c213ecded007000000000000160014f3194f0e628c5a2151c81208da242c056f024537e8030000000000002251203fc1d56923b331dc39d88bbe7b32bb2af5de56ab6e0bb4c695ce915d2a496988e80300000000000016001453c06b2e7fe528eef00ae748ab49093d976e5efea00f000000000000160014d18e0371ecba24396090c9d1528b048a7f0b0ae5d007000000000000225120e7c5b4944e9afe019e7b9829138f6bd24e2ed86e94ca5b7c7d11e71572f7348b894d780000000000225120cdf009b2f9aa0daeb3fe6528f222f8b397de58b200351511ba8f3c99a2a31827b80b000000000000160014bf195baef3cf62586c6fe582331f86c6cace2f65d0070000000000002251202670e0ad1c41620facf5b7a74369b1161ee0769d6b3796e446c5cace520ed75ce8030000000000001600141dba86b1a9be6409a8fd59b5c44b8b0144f76e97024730440220715b7e50a5860ca3edacb9c76219da40e925081d01bb731e64c4e3594561fd00022038135dd600641e3723d2da263d46da5a419625723a14001162718dc72a9c264e0121021c97d9b7771d52f40a1f7bad13c99c194d445b936180ef31f956efe10157481589602700',
        vout: 67,
      },
    ],
    senderId: 'tb1q7vv57rnz33dzz5wgzgyd5fpvq4hsy3fhmkekrz',
    recipientId: '2NGXH9aC46njoPrkdsA8BMcyYYb8x9VzBv8',
    amount: 1000,
    feeRate: 1,
  });
  console.log(res);
})();
